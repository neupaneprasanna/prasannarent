// This is your Prisma schema file
// Learn more at: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════
//  CORE MODELS
// ═══════════════════════════════════════════

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  avatar    String?
  bio       String?
  verified  Boolean  @default(false)
  role      Role     @default(USER)
  level     Int      @default(1)
  points    Int      @default(0)
  interests String[]

  // Extended Profile / Security
  address            String?
  city               String?
  dateOfBirth        DateTime?
  governmentIdType   String?
  governmentIdNumber String?

  // Security and Auth
  banned              Boolean   @default(false)
  bannedAt            DateTime?
  bannedReason        String?
  lastLoginAt         DateTime?
  loginCount          Int       @default(0)
  failedLoginAttempts Int       @default(0)
  lastPasswordChange  DateTime?
  twoFactorEnabled    Boolean   @default(false)
  lastSeenAt          DateTime? @default(now())

  // Referral
  referralCode String? @unique

  // Relations
  listings         Listing[]
  bookings         Booking[]
  reviews          Review[]
  sentMessages     Message[]      @relation("SentMessages")
  receivedMessages Message[]      @relation("ReceivedMessages")
  notifications    Notification[]
  badges           Badge[]

  // Messaging Relations
  conversationParticipants ConversationParticipant[]
  conversationMessages     ConversationMessage[]

  // Engagement Relations
  wishlistCollections WishlistCollection[]
  recentlyViewed      RecentlyViewed[]
  following           HostFollow[]         @relation("Following")
  followers           HostFollow[]         @relation("Followers")
  activityEvents      ActivityEvent[]
  hostProfile         HostProfile?

  // Growth Relations
  referralsMade    Referral[]        @relation("Referrals")
  referredBy       Referral[]        @relation("ReferredBy")
  promoRedemptions PromoRedemption[]

  // Admin Relations
  auditLogs   AuditLog[]             @relation("AdminAuditLogs")
  moderations ModerationItem[]       @relation("ModeratorReviews")
  campaigns   NotificationCampaign[] @relation("CampaignCreator")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([referralCode])
}

model Listing {
  id          String        @id @default(cuid())
  title       String
  description String
  price       Float
  priceUnit   PriceUnit     @default(DAY)
  category    String
  tags        String[]
  images      String[]
  location    String
  latitude    Float?
  longitude   Float?
  available   Boolean       @default(true)
  featured    Boolean       @default(false)
  views       Int           @default(0)
  rating      Float         @default(0)
  reviewCount Int           @default(0)
  status      ListingStatus @default(ACTIVE)

  // New listing fields
  condition            ItemCondition @default(GOOD)
  minRentalDays        Int           @default(1)
  maxRentalDays        Int?
  scheduledUnpublishAt DateTime?
  duplicatedFrom       String?
  trendScore           Float         @default(0)
  bookingCount         Int           @default(0)

  owner   User   @relation(fields: [ownerId], references: [id])
  ownerId String

  bookings      Booking[]
  reviews       Review[]
  conversations Conversation[]

  // New relations
  media          ListingMedia[]
  pricing        ListingPricing?
  dateOverrides  DatePriceOverride[]
  attributes     ListingAttribute[]
  calendarBlocks CalendarBlock[]
  wishlistItems  WishlistItem[]
  recentlyViewed RecentlyViewed[]
  boosts         ListingBoost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([ownerId])
  @@index([price])
  @@index([rating])
  @@index([status])
  @@index([trendScore(sort: Desc)])
}

model Booking {
  id         String        @id @default(cuid())
  startDate  DateTime
  endDate    DateTime
  totalPrice Float
  status     BookingStatus @default(PENDING)
  paymentId  String?
  ownerNote  String?

  // New booking fields
  renterNote       String?
  expiresAt        DateTime?
  counterPrice     Float?
  counterMessage   String?
  extensionEndDate DateTime?
  returnDate       DateTime?

  listing   Listing @relation(fields: [listingId], references: [id])
  listingId String
  renter    User    @relation(fields: [renterId], references: [id])
  renterId  String

  // New relations
  timeline BookingTimeline[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listingId])
  @@index([renterId])
  @@index([status])
  @@index([expiresAt])
}

model Review {
  id     String   @id @default(cuid())
  rating Int
  text   String
  images String[]

  listing   Listing @relation(fields: [listingId], references: [id])
  listingId String
  user      User    @relation(fields: [userId], references: [id])
  userId    String

  createdAt DateTime @default(now())

  @@index([listingId])
  @@index([userId])
}

model Message {
  id   String  @id @default(cuid())
  text String
  read Boolean @default(false)

  sender     User   @relation("SentMessages", fields: [senderId], references: [id])
  senderId   String
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id])
  receiverId String

  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
}

// ═══════════════════════════════════════════
//  MESSAGING / CONVERSATIONS
// ═══════════════════════════════════════════

model Conversation {
  id        String   @id @default(cuid())
  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])

  participants ConversationParticipant[]
  messages     ConversationMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listingId])
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  joinedAt       DateTime     @default(now())

  @@unique([userId, conversationId])
  @@index([userId])
  @@index([conversationId])
}

model ConversationMessage {
  id             String       @id @default(cuid())
  text           String
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([senderId])
}

model Notification {
  id      String  @id @default(cuid())
  type    String
  title   String
  message String
  read    Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id])
  userId String

  createdAt DateTime @default(now())

  @@index([userId])
}

model Badge {
  id          String @id @default(cuid())
  name        String
  description String
  icon        String

  users User[]

  @@unique([name])
}

// ═══════════════════════════════════════════
//  LISTING ENHANCEMENTS
// ═══════════════════════════════════════════

model ListingMedia {
  id        String    @id @default(cuid())
  listingId String
  listing   Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url       String
  type      MediaType @default(IMAGE)
  order     Int       @default(0)
  caption   String?
  width     Int?
  height    Int?
  duration  Float?
  thumbnail String?
  createdAt DateTime  @default(now())

  @@index([listingId])
  @@index([listingId, order])
}

model ListingPricing {
  id        String  @id @default(cuid())
  listingId String  @unique
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  hourlyPrice       Float?
  dailyPrice        Float
  weeklyPrice       Float?
  monthlyPrice      Float?
  weekendMultiplier Float  @default(1.0)
}

model DatePriceOverride {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  date      DateTime
  price     Float
  reason    String?

  @@unique([listingId, date])
  @@index([listingId])
}

model CategoryAttribute {
  id          String   @id @default(cuid())
  category    String
  name        String
  label       String
  type        String // text, number, select, boolean, date
  options     String[]
  required    Boolean  @default(false)
  order       Int      @default(0)
  unit        String?
  placeholder String?

  @@unique([category, name])
  @@index([category])
}

model ListingAttribute {
  id        String  @id @default(cuid())
  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  key       String
  value     String

  @@unique([listingId, key])
  @@index([listingId])
}

// ═══════════════════════════════════════════
//  BOOKING WORKFLOW
// ═══════════════════════════════════════════

model BookingTimeline {
  id        String   @id @default(cuid())
  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  status    String
  note      String?
  actor     String // "renter", "host", "system"
  createdAt DateTime @default(now())

  @@index([bookingId])
}

model CalendarBlock {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  startDate DateTime
  endDate   DateTime
  reason    String?

  @@index([listingId])
  @@index([listingId, startDate, endDate])
}

// ═══════════════════════════════════════════
//  ENGAGEMENT & DISCOVERY
// ═══════════════════════════════════════════

model WishlistCollection {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String  @default("Saved Items")
  emoji     String  @default("heart")
  isDefault Boolean @default(false)

  items WishlistItem[]

  createdAt DateTime @default(now())

  @@index([userId])
}

model WishlistItem {
  id           String             @id @default(cuid())
  collectionId String
  collection   WishlistCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  listingId    String
  listing      Listing            @relation(fields: [listingId], references: [id], onDelete: Cascade)
  addedAt      DateTime           @default(now())

  @@unique([collectionId, listingId])
  @@index([collectionId])
}

model RecentlyViewed {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now())

  @@unique([userId, listingId])
  @@index([userId, viewedAt(sort: Desc)])
}

model HostFollow {
  id         String   @id @default(cuid())
  followerId String
  follower   User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  hostId     String
  host       User     @relation("Followers", fields: [hostId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([followerId, hostId])
  @@index([hostId])
  @@index([followerId])
}

model ActivityEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
}

// ═══════════════════════════════════════════
//  REPUTATION & HOST PROFILES
// ═══════════════════════════════════════════

model HostProfile {
  id               String    @id @default(cuid())
  userId           String    @unique
  user             User      @relation(fields: [userId], references: [id])
  level            HostLevel @default(BRONZE)
  responseRate     Float     @default(100)
  avgResponseTime  Int       @default(0)
  completionRate   Float     @default(100)
  cancellationRate Float     @default(0)
  totalRentals     Int       @default(0)
  memberSince      DateTime  @default(now())
  lastCalculated   DateTime  @default(now())

  @@index([level])
  @@index([userId])
}

// ═══════════════════════════════════════════
//  MARKETPLACE GROWTH
// ═══════════════════════════════════════════

model Referral {
  id           String         @id @default(cuid())
  referrerId   String
  referrer     User           @relation("Referrals", fields: [referrerId], references: [id])
  refereeId    String?
  referee      User?          @relation("ReferredBy", fields: [refereeId], references: [id])
  code         String         @unique
  status       ReferralStatus @default(PENDING)
  rewardAmount Float          @default(10)
  redeemedAt   DateTime?
  createdAt    DateTime       @default(now())

  @@index([referrerId])
  @@index([code])
}

model PromoCode {
  id             String    @id @default(cuid())
  code           String    @unique
  discountType   String
  discountValue  Float
  maxUses        Int?
  currentUses    Int       @default(0)
  minOrderAmount Float?
  validFrom      DateTime  @default(now())
  validUntil     DateTime?
  active         Boolean   @default(true)
  createdAt      DateTime  @default(now())

  redemptions PromoRedemption[]

  @@index([code])
}

model PromoRedemption {
  id        String    @id @default(cuid())
  promoId   String
  promo     PromoCode @relation(fields: [promoId], references: [id])
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  bookingId String?
  discount  Float
  createdAt DateTime  @default(now())

  @@unique([promoId, userId])
  @@index([userId])
}

model ListingBoost {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  type      String
  startDate DateTime @default(now())
  endDate   DateTime
  active    Boolean  @default(true)

  @@index([listingId])
  @@index([type, active])
}

model Campaign {
  id             String   @id @default(cuid())
  title          String
  description    String?
  bannerImage    String?
  bannerLink     String?
  position       String   @default("home_top")
  targetCategory String?
  startDate      DateTime
  endDate        DateTime
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())

  @@index([position, active])
}

// ═══════════════════════════════════════════
//  ADMIN MODELS
// ═══════════════════════════════════════════

model AuditLog {
  id         String  @id @default(cuid())
  action     String
  module     String
  targetType String?
  targetId   String?
  details    Json?
  ipAddress  String?
  userAgent  String?

  admin   User   @relation("AdminAuditLogs", fields: [adminId], references: [id])
  adminId String

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([module])
  @@index([action])
  @@index([createdAt])
}

model FeatureFlag {
  id          String  @id @default(cuid())
  key         String  @unique
  name        String
  description String?
  enabled     Boolean @default(false)
  rollout     Int     @default(0)
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContentBlock {
  id      String  @id @default(cuid())
  section String
  key     String
  value   String
  type    String  @default("text")
  order   Int     @default(0)
  active  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([section, key])
  @@index([section])
}

model PlatformSetting {
  id          String  @id @default(cuid())
  key         String  @unique
  value       String
  type        String  @default("string")
  group       String  @default("general")
  description String?

  updatedAt DateTime @updatedAt
}

model ModerationItem {
  id         String           @id @default(cuid())
  type       String
  targetType String
  targetId   String
  reason     String?
  status     ModerationStatus @default(PENDING)
  priority   Int              @default(0)

  reviewer   User?     @relation("ModeratorReviews", fields: [reviewerId], references: [id])
  reviewerId String?
  reviewNote String?
  reviewedAt DateTime?

  createdAt DateTime @default(now())

  @@index([status])
  @@index([type])
  @@index([priority])
}

model AIConfig {
  id          String  @id @default(cuid())
  system      String
  parameter   String
  value       String
  description String?

  updatedAt DateTime @updatedAt

  @@unique([system, parameter])
}

model NotificationCampaign {
  id          String    @id @default(cuid())
  name        String
  type        String
  subject     String?
  body        String
  targetRoles Role[]
  status      String    @default("draft")
  scheduledAt DateTime?
  sentAt      DateTime?
  sentCount   Int       @default(0)

  admin   User   @relation("CampaignCreator", fields: [adminId], references: [id])
  adminId String

  createdAt DateTime @default(now())
}

// ═══════════════════════════════════════════
//  ENUMS
// ═══════════════════════════════════════════

enum Role {
  USER
  SUPER_ADMIN
  ADMIN
  MODERATOR
  FINANCE
  SUPPORT
  ANALYST
}

enum PriceUnit {
  HOUR
  DAY
  WEEK
  MONTH
}

enum BookingStatus {
  PENDING
  COUNTER_OFFERED
  CONFIRMED
  ACTIVE
  EXTENSION_REQUESTED
  EARLY_RETURN_REQUESTED
  COMPLETED
  CANCELLED
  EXPIRED
  DISPUTED
}

enum ListingStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  PAUSED
  SUSPENDED
  REJECTED
  ARCHIVED
}

enum ItemCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  WORN
}

enum MediaType {
  IMAGE
  VIDEO
  PANORAMA_360
}

enum HostLevel {
  BRONZE
  SILVER
  GOLD
  SUPERHOST
}

enum ReferralStatus {
  PENDING
  REGISTERED
  QUALIFIED
  REWARDED
  EXPIRED
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
}
